import { describe, it, expect, vi } from 'vitest';
import { printReport, maskSecret } from '../src/ui';
import { AnalysisReport } from '../src/analyzer';
import { ScanResult } from '../src/scanner';

describe('Security fix verification', () => {
    it('should not crash on short secrets and should mask them completely', () => {
        const report: AnalysisReport = {
            all: [],
            present: [],
            missing: [],
            empty: [],
            unused: []
        };
        const scanResult: ScanResult = {
            filesScanned: 1,
            usages: new Map(),
            warnings: [],
            secrets: [
                { value: 'abc', file: 'test.ts', line: 1, context: 'test' }
            ]
        };

        const consoleSpy = vi.spyOn(console, 'log').mockImplementation(() => {});

        // Should NOT throw now
        expect(() => printReport(report, scanResult)).not.toThrow();

        consoleSpy.mockRestore();
    });

    it('should correctly mask secrets of various lengths', () => {
        expect(maskSecret('abc')).toBe('***');
        expect(maskSecret('abcd')).toBe('****');
        expect(maskSecret('abcde')).toBe('a****');
        expect(maskSecret('abcdefgh')).toBe('ab******');
        expect(maskSecret('abcdefghijkl')).toBe('abc*********');
    });
});
